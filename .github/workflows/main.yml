name: VNC

on:
  workflow_dispatch:

jobs:
  secure-vnc:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Allow VNC Firewall
        run: |
          netsh advfirewall firewall add rule name="VNC" dir=in action=allow protocol=TCP localport=5900

      - name: Install UltraVNC
        run: |
          $url = "https://www.uvnc.com/component/jdownloads/send/0-/448-ultravnc-1-4-3-setup-x64-exe.html"
          $out = "$env:TEMP\uvnc.exe"
          Invoke-WebRequest $url -OutFile $out
          Start-Process $out -ArgumentList "/silent" -Wait

      - name: Set VNC Password (r1234567) and Start Service
        run: |
          $setpass = "C:\Program Files\UltraVNC\setpasswd.exe"

          & $setpass r1234567

          sc config uvnc_service start= auto
          Start-Service uvnc_service

      - name: Install Cloudflared
        run: |
          Invoke-WebRequest `
            https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe `
            -OutFile C:\cloudflared.exe

      - name: Start Cloudflare TCP Tunnel (VNC)
        run: |
          Start-Process -NoNewWindow -FilePath "C:\cloudflared.exe" `
            -ArgumentList "tunnel --url tcp://localhost:5900"

      - name: Show VNC Info
        run: |
          Write-Host "=============================="
          Write-Host " VNC READY (Cloudflare TCP)"
          Write-Host " Port: 5900"
          Write-Host " Password: r1234567"
          Write-Host "=============================="
          Write-Host ""
          Write-Host "Copy the trycloudflare hostname from logs."

      - name: Keep Runner Alive
        run: |
          Start-Sleep -Seconds 1800
