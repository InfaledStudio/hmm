name: VNC

on:
  workflow_dispatch:

jobs:
  secure-vnc:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Enable Desktop + Firewall
        run: |
          netsh advfirewall firewall add rule name="VNC" dir=in action=allow protocol=TCP localport=5901

      - name: Create User
        run: |
          $username = "VNC"
          $password = "Root@12345"
          $secure = ConvertTo-SecureString $password -AsPlainText -Force

          if (Get-LocalUser -Name $username -ErrorAction SilentlyContinue) {
              Remove-LocalUser -Name $username
          }

          New-LocalUser -Name $username -Password $secure -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $username

      - name: Install TightVNC
        run: |
          $url = "https://www.tightvnc.com/download/2.8.85/tightvnc-2.8.85-gpl-setup-64bit.msi"
          $out = "$env:TEMP\tightvnc.msi"
          Invoke-WebRequest $url -OutFile $out
          Start-Process msiexec.exe -ArgumentList "/i `"$out`" /quiet ADDLOCAL=Server" -Wait

          # Set VNC password
          reg add "HKLM\Software\TightVNC\Server" /v Password /t REG_BINARY /d 763643313233 /f
          reg add "HKLM\Software\TightVNC\Server" /v AcceptRfbConnections /t REG_DWORD /d 1 /f

          Restart-Service tvnserver -Force

      - name: Install Cloudflared
        run: |
          Invoke-WebRequest `
            https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe `
            -OutFile C:\cloudflared.exe

      - name: Start Cloudflare TCP Tunnel (VNC)
        run: |
          Start-Process -NoNewWindow -FilePath "C:\cloudflared.exe" `
            -ArgumentList "tunnel --url tcp://localhost:5901"

      - name: Show VNC Details
        run: |
          Write-Host "=============================="
          Write-Host " VNC READY (Cloudflare TCP)"
          Write-Host " Port: 5901"
          Write-Host " VNC Password: vnc123"
          Write-Host "=============================="

      - name: Keep Runner Alive
        run: |
          Start-Sleep -Seconds 1800
