name: VNC

on:
  workflow_dispatch:

jobs:
  secure-vnc:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Allow VNC Firewall
        run: |
          netsh advfirewall firewall add rule name="VNC" dir=in action=allow protocol=TCP localport=5900

      - name: Download UltraVNC Installer (REAL EXE)
        run: |
          $url = "https://www.uvnc.com/downloads/ultravnc/1440/UltraVNC_1_4_4_0_X64_Setup.exe"
          $out = "$env:TEMP\ultravnc.exe"
          Invoke-WebRequest -Uri $url -OutFile $out

      - name: Install UltraVNC (Service Mode)
        run: |
          Start-Process "$env:TEMP\ultravnc.exe" `
            -ArgumentList "/silent" `
            -Wait

      - name: Set VNC Password (r1234567) and Start Service
        run: |
          $setpass = "C:\Program Files\UltraVNC\setpasswd.exe"

          & "$setpass" r1234567

          sc config uvnc_service start= auto
          Start-Service uvnc_service

      - name: Verify VNC is Listening
        run: |
          netstat -ano | findstr 5900

      - name: Install Cloudflared
        run: |
          Invoke-WebRequest `
            https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe `
            -OutFile C:\cloudflared.exe

      - name: Start Cloudflare TCP Tunnel (VNC)
        run: |
          Start-Process -NoNewWindow `
            -FilePath "C:\cloudflared.exe" `
            -ArgumentList "tunnel --url tcp://localhost:5900"

      - name: Show VNC Info
        run: |
          Write-Host "=============================="
          Write-Host " VNC READY (Cloudflare TCP)"
          Write-Host " Port: 5900"
          Write-Host " Password: r1234567"
          Write-Host "=============================="
          Write-Host ""
          Write-Host "ðŸ‘‰ Copy the trycloudflare hostname from logs"
          Write-Host "ðŸ‘‰ Use cloudflared access tcp on your PC"

      - name: Keep Runner Alive
        run: |
          Start-Sleep -Seconds 1800
